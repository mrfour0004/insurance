<div id="pg-claim-apply" class="pg has-aside">
    <div class="pg-aside">
        <div class="aside-hd">現場理賠服務</div>
        <div class="aside-ctn">
            <ul class="aside-lists">
                <li class="aside-list active" link="basic">
                    <h4>基本資料</h4>
                </li>
                <li class="aside-list" link="accident">
                    <h4>事故資訊</h4>
                </li>
                <li class="aside-list" link="damage">
                    <h4>人物損傷</h4>
                </li>
                <li class="aside-list" link="relevant">
                    <h4>相關保單</h4>
                </li>
            </ul>
        </div>
    </div>
    <div class="pg-main">
        <div class="main-hd">
            <div class="pg-hd-icon progress-radial fr" id="btn-save">
                <div class="radial-progress" data-progress="75">
                    <div class="circle">
                        <div class="mask full">
                            <div class="fill"></div>
                        </div>
                        <div class="mask half" style="
">
                            <div class="fill"></div>
                            <div class="fill fix"></div>
                        </div>

                    </div>

                </div>
                <img alt="" src="img/icons/PNG-active/upload2.png" />
            </div>
        </div>
        <div class="main-ctns fs-field">
            <div class="main-ctn touchScroll fs-current" link="basic">
                <div class="form-ctnr">
                    <h3 class="form-hd">被保險人</h3>
                    <div class="form-ctn">
                        <div class="form-row">
                            <div class="form-td gd-33">
                                <label>被保險人</label>
                                <input type="text" id="ipt_insured_name" />
                            </div>
                            <div class="form-td gd-33">
                                <label>汽車牌號</label>
                                <input type="text" id="ipt_insured_car_license_plate" class="uppercase" />
                            </div>
                            <div class="form-td gd-33">
                                <label>引擎(車身)號碼</label>
                                <input type="text" id="ipt_insured_car_engine" class="uppercase" />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-td gd-66">
                                <label>Email</label>
                                <input type="text" id="ipt_insured_email" />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-td gd-33">
                                <label>行動電話</label>
                                <input type="tel" id="ipt_insured_tel_mobile" />
                            </div><div class="form-td gd-33">
                                <label>公司電話</label>
                                <input type="tel" id="ipt_insured_tel_company" />
                            </div><div class="form-td gd-33">
                                <label>住宅電話</label>
                                <input type="tel" id="ipt_insured_tel_home" />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-td gd-33">
                                <label>地址</label>
                                <input type="text" id="ipt_insured_address" />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-ctnr">
                    <h3 class="form-hd">駕駛人</h3>
                    <div class="form-ctn">
                        <div class="form-row">
                            <div class="form-td gd-33">
                                <label>駕駛人</label>
                                <input type="text" id="ipt_driver_name" />
                            </div>
                            <div class="form-td title gd-33">
                                <label>出生日期</label>
                                <input type="date" id="ipt_driver_birthday" class="uppercase" />
                            </div>
                            <div class="form-td gd-33">
                                <label>職業</label>
                                <input type="text" id="ipt_driver_occupation" class="uppercase" />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-td title gd-33">
                                <label>駕照號碼</label>
                                <input type="number" id="ipt_driver_license_plate" class="uppercase" />
                            </div>
                            <div class="form-td gd-33">
                                <label>領照日期</label>
                                <input type="date" id="ipt_driver_license_releasedDate" />
                            </div>
                            <div class="form-td gd-33">
                                <label>與駕駛人關係</label>
                                <select id="ipt_driver_relationship">
                                    <option value="1" selected>本人</option>
                                    <option value="2">配偶</option>
                                    <option value="3">父母</option>
                                    <option value="4">子女</option>
                                    <option value="5">兄弟姊妹</option>
                                    <option value="6">友人</option>
                                    <option value="7">其他</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="main-ctn touchScroll" link="accident">
                <div class="form-ctnr">
                    <h3 class="form-hd">事故情形概述</h3>
                    <div class="form-ctn">
                        <div class="form-row">
                            <div class="form-ctn gd-66">
                                <div class="form-row">
                                    <div class="form-td gd-33">
                                        <label>事故地點</label>
                                        <select id="ipt_accident_location_type" role="ctrl">
                                            <option value="city">縣市</option>
                                            <option value="highway">國道</option>
                                        </select>
                                    </div>
                                    <div class="form-td gd-66">
                                        <label>事故時間</label>
                                        <input type="date" id="ipt_accident_time" />
                                    </div>
                                </div>
                                <div class="form-ctrl-row" for="ipt_accident_location_type">
                                    <div class="form-row vCtrl active" target="city">
                                        <div class="form-td gd-33">
                                            <label>縣市</label>
                                            <input type="text" id="ipt_accident_city" />
                                        </div>
                                        <div class="form-td gd-33">
                                            <label>鄉鎮</label>
                                            <input type="text" id="ipt_accident_township" />
                                        </div>
                                        <div class="form-td gd-33">
                                            <label>道路</label>
                                            <input type="text" id="ipt_accident_road" />
                                        </div>
                                    </div>
                                    <div class="form-row vCtrl" target="highway">
                                        <div class="form-td gd-33">
                                            <label>國道</label>
                                            <input type="text" id="ipt_accident_highway" />
                                        </div>
                                        <div class="form-td gd-33">
                                            <label>方向</label>
                                            <input type="text" id="ipt_accident_highway_direction" />
                                        </div>
                                        <div class="form-td gd-33">
                                            <label>公里</label>
                                            <input type="text" id="ipt_accident_highway_km" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-td row-span-2 gd-33">
                                <label>事故現場示意圖</label>
                                <input type="hidden" id="ipt_accident_pic" />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-td gd-100">
                                <label>肇事經過</label>
                                <input type="text" id="ipt_accident_description" />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-td gd-33">
                                <label>警憲處理</label>
                                <select id="ipt_police_handle">
                                    <option value="1" selected>憲警立即現場處理</option>
                                    <option value="2">事後憲警單位備案</option>
                                    <option value="3">無憲警單位處理</option>
                                    <option value="4">理賠人員事故現場處理</option>
                                </select>
                            </div>
                            <div class="form-td gd-66">
                                <label>出險原因</label>
                                <input type="text" id="ipt_claim_reason" />
                            </div>
                        </div>
                        <div class="form-accordion-row active" for="ipt_police_handle">
                            <div class="form-row">
                                <div class="form-td gd-33">
                                    <label>憲警單位</label>
                                    <input type="text" id="ipt_police_branch" />
                                </div>
                                <div class="form-td gd-33">
                                    <label>憲警單位電話</label>
                                    <input type="tel" id="ipt_police_tel" />
                                </div>
                                <div class="form-td gd-33">
                                    <label>處理憲警姓名</label>
                                    <input type="text" id="ipt_police_name" />
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-td gd-33">
                                <label>拖吊業者</label>
                                <input type="text" id="ipt_tow_company" />
                            </div>
                            <div class="form-td gd-33">
                                <label>拖吊業者電話</label>
                                <input type="tel" id="ipt_tow_tel" />
                            </div>
                            <div class="form-td gd-33">
                                <label>拖吊駕駛姓名</label>
                                <input type="text" id="ipt_tow_driver" />
                            </div>

                        </div>
                    </div>
                </div>
            </div>
            <div class="main-ctn touchScroll" link="damage">
                <div class="form-ctnr">
                    <h3 class="form-hd">傷亡人員</h3>
                    <div class="form-ctn">
                        <div class="form-row">
                            <div class="form-td gd-33">
                                <label>姓名</label>
                                <input type="text" id="ipt_casualty_name" />
                            </div>
                            <div class="form-td gd-33">
                                <label>電話</label>
                                <input type="text" id="ipt_casualty_tel" />
                            </div>
                            <div class="form-td gd-33">
                                <label>乘座別</label>
                                <input type="text" id="ipt_casualty_vehicle" />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-td gd-33">
                                <label>診治醫院</label>
                                <input type="text" id="ipt_casualty_hospital" />
                            </div>
                            <div class="form-td gd-66">
                                <label>受傷情形描述</label>
                                <input type="text" id="ipt_casualty_description" />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-ctnr">
                    <h3 class="form-hd">損壞車輛</h3>
                    <div class="form-ctn">
                        <div class="form-row">
                            <div class="form-td gd-33">
                                <label>車牌號碼</label>
                                <input type="number" id="ipt_damagedCar_license" />
                            </div>
                            <div class="form-td gd-33">
                                <label>駕駛人</label>
                                <input type="text" id="ipt_damagedCar_driver" />
                            </div>
                            <div class="form-td gd-33">
                                <label>電話</label>
                                <input type="text" id="ipt_damagedCar_driver_tel" />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-td gd-33">
                                <label>維修廠商</label>
                                <input type="text" id="ipt_damagedCar_repair" />
                            </div>
                            <div class="form-td gd-66">
                                <label>損壞情形描述</label>
                                <input type="text" id="ipt_damagedCar_description" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="main-ctn touchScroll" link="relevant">
            </div>
        </div>
    </div>
</div>
<script>
    var fs = {
        load: function (link) {
            var curidx = $(".main-ctns > .main-ctn.fs-current").index();
            var idx = $(".main-ctns > .main-ctn[link='" + link + "']").index();
            if (curidx > idx) {
                this.toPrev(idx);
            } else if (curidx < idx) {
                this.toNext(idx);
            }
        },
        toNext: function (i) {
            var curr = $(".main-ctns > .main-ctn.fs-current");
            var next = (typeof (i) == "undefined") ? $($(".main-ctns > .main-ctn")[$(".main-ctns > .main-ctn.fs-current").index() + 1]) : $($(".main-ctns > .main-ctn")[i]);

            //var field = $(".fs-field");
            //field.addClass("fs-display-next");

            curr.addClass("fs-animHidePrev").one("webkitAnimationEnd oAnimationEnd", function () {
                $(this).removeClass("fs-current fs-animHidePrev");
            });
            next.addClass("fs-current fs-animShowNext").one("webkitAnimationEnd oAnimationEnd", function () {
                $(this).removeClass("fs-animShowNext");
            });
        },
        toPrev: function (i) {
            var curr = $(".main-ctns > .main-ctn.fs-current");
            var prev = (typeof (i) == "undefined") ? $($(".main-ctns > .main-ctn")[$(".main-ctns > .main-ctn.fs-current").index() + 1]) : $($(".main-ctns > .main-ctn")[i]);

            //var field = $(".fs-field");
            //field.addClass("fs-display-next");

            curr.addClass("fs-animHideNext").one("webkitAnimationEnd oAnimationEnd", function () {
                $(this).removeClass("fs-animHideNext fs-current");
            });
            prev.addClass("fs-current fs-animShowPrev").one("webkitAnimationEnd oAnimationEnd", function () {
                $(this).removeClass("fs-animShowPrev");
            });
        },
    };
    var claimForm = {
        accordion: {
            show: function (t) {
                t.addClass("active");
            },
            hide: function (t) {
                t.removeClass("active");
            }
        },
        ctrl: {
            load: function (t, v) {
                var curr = t.find(".form-row.active");
                var target = t.find(".form-row[target='" + v + "']");
                if (curr.attr("target") != target.attr("target")) {
                    target.addClass("active");
                    curr.removeClass("active");
                }
            }
        },
        getInfo: function () {
            var info = claimSamples[0];

            $.each($("input[id^=ipt_], select[id^=ipt_]"), function (v) {
                var attr = $(this).attr("id").replace("ipt_", "");
                if (typeof (info[attr]) != "undefined") {
                    info[attr] = $(this).val();
                }
            });

            console.log(info);
            return info;
        },
        save: function () {
            var claimInfo = this.getInfo();
            var claim_status = '4';   
            claimInfo.claimNo = (new Date().valueOf()).toString();
            claimInfo.claim_status = claim_status;

            dbobj.insert("claim", claimInfo, function () {
                console.log("save successfully...");

                var task = {
                    "claimNo": claimInfo.claimNo,
                    "source": "Henk",
                    "step": claim_status,
                    "claimant": claimInfo.claimant_name,
                    "startDate": new Date.today().add(parseInt(Math.random() * 3)).toString("yyyyMMdd"),
                    "endDate": new Date.today().add(parseInt(Math.random() * 3 + 3)).days().toString("yyyyMMdd")
                };

                dbobj.insert("task", task, function () {
                    console.log("add a new task successfully...", JSON.stringify(task));
                });
            });
        },
        upload: function () {

        }
    }

    function loadPolicy() {
        var tmp = claimSamples[0];
        $.each(tmp, function (k, v) {
            if (v != "")
                $("#ipt_" + k).val(v).prop("disabled", true);
        });
    }

    $("#pg-claim-apply .aside-list").click(function () {
        if (!$(this).hasClass("active")) {
            var link = $(this).attr("link");
            var target = $("#pg-claim-apply .aside-list[link='" + link + "']");

            $("#pg-claim-apply .aside-list.active").removeClass("active");
            target.addClass("active");

            fs.load(link);
        }
    });
    $("select[role='ctrl']").change(function () {
        var v = $(this).val();
        console.log($(this).attr("id"));
        claimForm.ctrl.load($(".form-ctrl-row[for='" + $(this).attr("id") + "']"), v);
    });
    $("#ipt_police_handle").change(function () {
        var v = $(this).val();
        var t = $(".form-accordion-row[for='" + $(this).attr("id") + "']");
        if (v == "1" || v == "2") {
            claimForm.accordion.show(t);
        } else {
            claimForm.accordion.hide(t);
        }
    });
    $("#btn-save").click(function () {
        claimForm.save();
        view.notify.alert("成功送出", "", function () {
            view.page.load("tasks");
        });
    });

    loadPolicy();
</script>